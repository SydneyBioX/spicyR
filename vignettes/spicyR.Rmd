---
title: "Spatial Mixed-Effects Modelling with spicy"
date: "`r BiocStyle::doc_date()`"
params:
  test: FALSE
author:
- name: Nicolas Canete
  affiliation:  
  - &WIMR Westmead Institute for Medical Research, University of Sydney, Australia
  email: nicolas.canete@sydney.edu.au
- name: Ellis Patrick
  affiliation:
  - &WIMR Westmead Institute for Medical Research, University of Sydney, Australia
  - School of Mathematics and Statistics, University of Sydney, Australia
- name: Alex Qin
  affiliation:
  - &WIMR Westmead Institute for Medical Research, University of Sydney, Australia
  - School of Mathematics and Statistics, University of Sydney, Australia
package: "`r BiocStyle::pkg_ver('spicyR')`"
abstract: "Perform linear and mixed-effects models to assess and visualise changes 
in cell localisation across disease conditions."
vignette: >
  %\VignetteIndexEntry{"Introduction to spicy"}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
output: 
  BiocStyle::html_document
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  warning = FALSE
)
library(BiocStyle)
```


# Installation

```{r, eval = FALSE}
if (!require("BiocManager")) {
  install.packages("BiocManager")
}
BiocManager::install("spicyR")
```

```{r warning=FALSE, message=FALSE}
# load required packages
library(spicyR)
library(ggplot2)
library(SingleCellExperiment)
library(SpatialExperiment)
library(imcRtools)
```


```{r warning=FALSE, message=FALSE, echo=FALSE}
htmltools::includeCSS("../inst/hexagons.css")
htmltools::includeHTML("../inst/spatialHeader.html")
```

# Overview

This guide provides step-by-step instructions on how to apply mixed effects models to multiple segmented and labelled images to assess how the localisation of different cell types changes across different disease conditions. The subject is modelled as a random effect, and the different disease conditions are modelled as a fixed effect.

# Example data

We use a subset of the Damond et al., (2019) imaging mass cytometry dataset. We compare the spatial distributions of cells in the pancreatic islets of individuals with early onset diabetes and healthy controls.

The data is stored as a `SingleCellExperiment` object and contains single-cell data of 160 images from 8 subjects, with 20 images per subject.


```{r}
data("diabetesData")
diabetesData
```

The cell types in this data set include immune cell types (B cells, naive T cells, T Helper cells, T cytotoxic cells, neutrophils, macrophages) and pancreatic islet cells (alpha, beta, gamma, delta).

# Mixed Effects Modelling

To investigate changes in localisation between two different cell types, we 
measure the level of localisation between two cell types by modelling with the 
L-function. The L-function is a variance-stabilised K-function given by the equation

$$
\widehat{L_{ij}} (r) = \sqrt{\frac{\widehat{K_{ij}}(r)}{\pi}}
$$

with $\widehat{K_{ij}}$ defined as 

$$
\widehat{K_{ij}} (r) = \frac{|W|}{n_i n_j} \sum_{n_i} \sum_{n_j} 1 \{d_{ij} \leq r \} e_{ij} (r)
$$

where $\widehat{K_{ij}}$ summarises the degree of co-localisation of cell type $j$ with cell type $i$, $n_i$ and $n_j$ are the number of cells of type $i$ and $j$, $|W|$ is the image area, $d_{ij}$ is the distance between two cells and $e_{ij} (r)$ is an edge correcting factor.

Specifically, the mean difference between the experimental function and the theoretical function is used as a measure for the level of localisation, defined as

$$
u = \sum_{r' = r_{\text{min}}}^{r_{\text{max}}} \widehat L_{ij, \text{Experimental}} (r') - \widehat L_{ij, \text{Poisson}} (r')
$$
where is the sum is taken over a discrete range of $r$ between $r_{\text{min}}$ and $r_{\text{max}}$.


Differences of the statistic $u$ between two  conditions is modelled using a weighted mixed effects model, with condition as the fixed effect and subject as the random effect.

## Test for change in localisation for a specific pair of cells

Firstly, we can test whether one cell type tends to be more localised with another cell type in one condition compared to the other. This can be done using the `spicy()` function, where we specify `condition`, and `subject`. 

In this example, we want to see whether or not delta cells (`to`) tend to be found around beta cells (`from`) in onset diabetes images compared to non-diabetic images. Given that there are 3 conditions, we can specify the desired conditions by setting the order of our `condition` factor. `spicy()` will choose the first level of the factor as the base condition and the second level as the comparison condition. `spicy()` will also naturally coerce the `condition` column into a factor if it is not already a factor. The column containing cell type annotations can be specified using the `cellTypeCol` argument. By default, `spicy()` uses the column named `cellType` in the `SpatialExperiment` object.


```{r message=FALSE}
spicyTestPair <- spicy(
  diabetesData,
  condition = "stage",
  subject = "case",
  from = "beta",
  to = "delta"
)

topPairs(spicyTestPair)
```

We obtain a `spicy` object which details the results of the mixed effects 
modelling performed. The `topPairs()` function can be used to obtain the associated coefficients and p-value.

As the `coefficient` in `spicyTestPair` is negative, we find that delta cells are significantly less likely to be found near beta cells in the onset diabetes group compared to the non-diabetic control.

## Test for change in localisation for all pairwise cell combinations

We can perform what we did above for all pairwise combinations of cell 
types by excluding the `from` and `to` parameters in `spicy()`.

```{r message=FALSE, eval=F}
spicyTest <- spicy(
  diabetesData,
  condition = "stage",
  subject = "case"
)

topPairs(spicyTest)
```

Again, we obtain a `spicy` object which outlines the result of the mixed effects 
models performed for each pairwise combination of cell types.

We can also examine the L-function metrics of individual images by using the
convenient `bind()` function on our `spicyTest` results object.

```{r}
bind(spicyTest)[1:5, 1:5]
```

The results can be represented as a bubble plot using the `signifPlot()` function. Here, we can observe that the most significant relationships occur between pancreatic beta and delta cells, suggesting that the two cell types are far more localised during diabetes onset compared to non-diabetics.

```{r}
signifPlot(
  spicyTest,
  breaks = c(-3, 3, 1),
  marksToPlot = c(
    "alpha", "beta", "gamma", "delta",
    "B", "naiveTc", "Th", "Tc", "neutrophil", "macrophage"
  )
)
```


To examine a specific cell type-cell type relationship in more detail, we can use `spicyBoxplot()` and specify either `from = beta` and `to = delta` or `rank = 1`.


```{r}
spicyBoxPlot(results = spicyTest,
             # from = "beta",
             # to = "delta",
             rank = 1)
```

## Mixed effects modelling for custom metrics

`spicyR` can also be applied to custom distance or abundance metrics. We first obtain the custom abundance metric by converting the existing `SingleCellExperiment` object into a `SpatialExperiment` object. A kNN interactions graph is then generated with the function `buildSpatialGraph` from the `imcRtools` package. This generates a `colPairs` object inside of the `SpatialExperiment` object.

`spicyR` provides the function `convPairs` for converting a `colPairs` object into an abundance matrix by calculating the average number of nearby cells types for every cell type for a given `k`. For example, if there exists on average 5 neutrophils for every macrophage in image 1, the column `neutrophil__macrophage` would have a value of 5 for image 1.

```{r}
diabetesData_SPE <- SpatialExperiment(diabetesData,
                                      colData = colData(diabetesData)) 

spatialCoords(diabetesData_SPE) <- data.frame(colData(diabetesData_SPE)$x, colData(diabetesData_SPE)$y) |> as.matrix()
spatialCoordsNames(diabetesData_SPE) <- c("x", "y")

diabetesData_SPE <- imcRtools::buildSpatialGraph(diabetesData_SPE, img_id = "imageID", type = "knn", k = 20, coords = c("x", "y"))

pairAbundances <- convPairs(diabetesData_SPE,
                  colPair = "knn_interaction_graph")

head(pairAbundances["delta__delta"])
```

`spicy` can take any input of pairwise cell type combinations across 
multiple images and run a mixed effects model to determine collective differences
across conditions. The `Statial` package contains other custom distance metrics which can be used with `spicy`.

```{r}
spicyTestColPairs <- spicy(
  diabetesData_SPE,
  condition = "stage",
  subject = "case",
  alternateResult = pairAbundances,
  weights = FALSE
)

topPairs(spicyTestColPairs)
```

```{r}
signifPlot(
  spicyTestColPairs,
  marksToPlot = c(
    "alpha", "acinar", "ductal", "naiveTc", "neutrophil", "Tc",
    "Th", "otherimmune"
  )
)
```

# sessionInfo()

```{r}
sessionInfo()
```

